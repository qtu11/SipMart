-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.achievements (
  achievement_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  badge_id text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  icon text,
  rarity text,
  requirement integer DEFAULT 1,
  reward_points integer DEFAULT 0,
  special_reward text,
  category text,
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT achievements_pkey PRIMARY KEY (achievement_id)
);
CREATE TABLE public.admin_actions (
  action_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  admin_id uuid NOT NULL,
  type text NOT NULL,
  details text NOT NULL,
  timestamp timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_actions_pkey PRIMARY KEY (action_id),
  CONSTRAINT admin_actions_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.admin_roles (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  role_name text NOT NULL UNIQUE,
  permissions jsonb,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admins (
  admin_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email text NOT NULL UNIQUE,
  display_name text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['super_admin'::text, 'store_admin'::text])),
  store_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  user_id uuid,
  CONSTRAINT admins_pkey PRIMARY KEY (admin_id),
  CONSTRAINT admins_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT admins_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.audit_logs (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  actor_id uuid,
  actor_type text NOT NULL CHECK (actor_type = ANY (ARRAY['user'::text, 'admin'::text, 'system'::text])),
  action text NOT NULL,
  resource_type text NOT NULL,
  resource_id text,
  old_value jsonb,
  new_value jsonb,
  ip_address text,
  user_agent text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (log_id)
);
CREATE TABLE public.badges (
  badge_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  name_en text,
  description text,
  icon text,
  icon_url text,
  category text DEFAULT 'general'::text CHECK (category = ANY (ARRAY['eco_warrior'::text, 'streak'::text, 'social'::text, 'special'::text, 'general'::text])),
  requirement_type text NOT NULL CHECK (requirement_type = ANY (ARRAY['cup_count'::text, 'streak'::text, 'referral'::text, 'challenge'::text, 'points'::text, 'special'::text])),
  requirement_value integer NOT NULL DEFAULT 1,
  points_reward integer DEFAULT 0,
  rarity text DEFAULT 'common'::text CHECK (rarity = ANY (ARRAY['common'::text, 'rare'::text, 'epic'::text, 'legendary'::text])),
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT badges_pkey PRIMARY KEY (badge_id)
);
CREATE TABLE public.buses (
  bus_id uuid NOT NULL DEFAULT gen_random_uuid(),
  route_code text NOT NULL,
  route_name text NOT NULL,
  vehicle_number text,
  qr_data text NOT NULL,
  status text DEFAULT 'active'::text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT buses_pkey PRIMARY KEY (bus_id)
);
CREATE TABLE public.campaigns (
  campaign_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  description text,
  type text,
  target text,
  reward_type text,
  reward_value jsonb,
  start_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT campaigns_pkey PRIMARY KEY (campaign_id)
);
CREATE TABLE public.challenges (
  challenge_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  description text,
  type text,
  requirement jsonb,
  reward_points integer,
  reward_badge text,
  start_date timestamp with time zone NOT NULL,
  end_date timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT challenges_pkey PRIMARY KEY (challenge_id)
);
CREATE TABLE public.cleaning_hubs (
  hub_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  location text,
  capacity integer DEFAULT 100,
  current_load integer DEFAULT 0,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'maintenance'::text, 'closed'::text])),
  manager_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cleaning_hubs_pkey PRIMARY KEY (hub_id),
  CONSTRAINT cleaning_hubs_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.cleaning_jobs (
  job_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  store_id uuid NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  cup_count integer NOT NULL CHECK (cup_count > 0),
  assigned_to text,
  priority text DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['low'::text, 'normal'::text, 'high'::text, 'urgent'::text])),
  created_at timestamp with time zone DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  notes text,
  created_by uuid,
  CONSTRAINT cleaning_jobs_pkey PRIMARY KEY (job_id),
  CONSTRAINT cleaning_jobs_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id),
  CONSTRAINT cleaning_jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.cleaning_queue (
  queue_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  branch_id uuid NOT NULL,
  cup_count integer NOT NULL DEFAULT 0,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'requested'::text, 'scheduled'::text, 'completed'::text])),
  requested_at timestamp with time zone,
  requested_by uuid,
  scheduled_pickup timestamp with time zone,
  completed_at timestamp with time zone,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cleaning_queue_pkey PRIMARY KEY (queue_id),
  CONSTRAINT cleaning_queue_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.partner_branches(branch_id),
  CONSTRAINT cleaning_queue_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.partner_users(user_id)
);
CREATE TABLE public.cleaning_sessions (
  session_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  hub_id uuid,
  cup_count integer NOT NULL CHECK (cup_count > 0),
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  staff_id uuid,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  notes text,
  CONSTRAINT cleaning_sessions_pkey PRIMARY KEY (session_id),
  CONSTRAINT cleaning_sessions_hub_id_fkey FOREIGN KEY (hub_id) REFERENCES public.cleaning_hubs(hub_id),
  CONSTRAINT cleaning_sessions_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.comments (
  comment_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  post_id uuid NOT NULL,
  user_id uuid NOT NULL,
  display_name text,
  content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT comments_pkey PRIMARY KEY (comment_id),
  CONSTRAINT comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.green_feed_posts(post_id),
  CONSTRAINT comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.conversation_participants (
  participant_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid NOT NULL,
  user_id uuid NOT NULL,
  nickname text,
  joined_at timestamp with time zone DEFAULT now(),
  last_read_at timestamp with time zone DEFAULT now(),
  theme_color text DEFAULT '#10b981'::text,
  bg_color text DEFAULT '#f9fafb'::text,
  is_muted boolean DEFAULT false,
  CONSTRAINT conversation_participants_pkey PRIMARY KEY (participant_id),
  CONSTRAINT conversation_participants_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(conversation_id),
  CONSTRAINT conversation_participants_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.conversations (
  conversation_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  type text NOT NULL CHECK (type = ANY (ARRAY['private'::text, 'group'::text])),
  name text,
  image_url text,
  last_message_text text,
  last_message_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversations_pkey PRIMARY KEY (conversation_id)
);
CREATE TABLE public.cup_cleaning_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  cup_id text NOT NULL,
  job_id uuid,
  cleaned_by text NOT NULL,
  cleaned_at timestamp with time zone DEFAULT now(),
  condition text DEFAULT 'good'::text CHECK (condition = ANY (ARRAY['good'::text, 'damaged'::text, 'needs_repair'::text, 'retired'::text])),
  notes text,
  cleaning_process text DEFAULT 'standard'::text CHECK (cleaning_process = ANY (ARRAY['uv_sterilize'::text, 'steam_clean'::text, 'chemical_sanitize'::text, 'manual_wash'::text, 'standard'::text])),
  store_id uuid,
  batch_number text,
  temperature_celsius integer,
  duration_seconds integer,
  CONSTRAINT cup_cleaning_logs_pkey PRIMARY KEY (id),
  CONSTRAINT cup_cleaning_logs_cup_id_fkey FOREIGN KEY (cup_id) REFERENCES public.cups(cup_id),
  CONSTRAINT cup_cleaning_logs_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.cleaning_jobs(job_id),
  CONSTRAINT cup_cleaning_logs_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.cups (
  cup_id text NOT NULL,
  material text NOT NULL CHECK (material = ANY (ARRAY['pp_plastic'::text, 'bamboo_fiber'::text])),
  status text DEFAULT 'available'::text CHECK (status = ANY (ARRAY['available'::text, 'in_use'::text, 'cleaning'::text, 'lost'::text, 'broken'::text])),
  created_at timestamp with time zone DEFAULT now(),
  last_cleaned_at timestamp with time zone,
  total_uses integer DEFAULT 0,
  current_user_id uuid,
  current_transaction_id uuid,
  store_id uuid,
  current_store_id uuid,
  deleted_at timestamp with time zone,
  max_uses integer DEFAULT 500,
  manufacture_date date DEFAULT CURRENT_DATE,
  cleaning_hub_id uuid,
  batch_id text,
  qr_code_url text,
  condition_score integer DEFAULT 100 CHECK (condition_score >= 0 AND condition_score <= 100),
  last_inspection_at timestamp with time zone,
  retirement_reason text,
  CONSTRAINT cups_pkey PRIMARY KEY (cup_id),
  CONSTRAINT cups_current_user_id_fkey FOREIGN KEY (current_user_id) REFERENCES public.users(user_id),
  CONSTRAINT cups_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id),
  CONSTRAINT fk_cups_current_store FOREIGN KEY (current_store_id) REFERENCES public.stores(store_id),
  CONSTRAINT cups_cleaning_hub_id_fkey FOREIGN KEY (cleaning_hub_id) REFERENCES public.cleaning_hubs(hub_id)
);
CREATE TABLE public.deposit_transactions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  transaction_id uuid NOT NULL,
  amount numeric NOT NULL CHECK (amount >= 0::numeric),
  type text NOT NULL CHECK (type = ANY (ARRAY['deposit'::text, 'refund'::text, 'penalty'::text, 'forfeit'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text])),
  reason text,
  processed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  processed_at timestamp with time zone,
  CONSTRAINT deposit_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT deposit_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT deposit_transactions_transaction_id_fkey FOREIGN KEY (transaction_id) REFERENCES public.transactions(transaction_id),
  CONSTRAINT deposit_transactions_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.device_usage_logs (
  log_id uuid NOT NULL DEFAULT gen_random_uuid(),
  device_id uuid,
  user_id uuid,
  used_at timestamp with time zone DEFAULT now(),
  duration_seconds integer,
  energy_consumed_kwh numeric,
  resource_saved_type character varying,
  resource_saved_amount numeric,
  eco_points_earned integer DEFAULT 0,
  CONSTRAINT device_usage_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT device_usage_logs_device_id_fkey FOREIGN KEY (device_id) REFERENCES public.smart_devices(device_id),
  CONSTRAINT device_usage_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.ebike_rentals (
  rental_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  bike_id text NOT NULL,
  start_station_id uuid NOT NULL,
  end_station_id uuid,
  start_time timestamp with time zone NOT NULL DEFAULT now(),
  end_time timestamp with time zone,
  duration_hours numeric,
  planned_duration_hours numeric,
  fare numeric NOT NULL,
  commission_amount numeric DEFAULT 0,
  partner_amount numeric DEFAULT 0,
  distance_km numeric DEFAULT 0,
  co2_saved_kg numeric DEFAULT 0,
  vnes_points_earned integer DEFAULT 0,
  status text DEFAULT 'ongoing'::text CHECK (status = ANY (ARRAY['ongoing'::text, 'completed'::text, 'cancelled'::text, 'violation'::text])),
  violation_reason text,
  is_returned_at_station boolean DEFAULT false,
  gps_route jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ebike_rentals_pkey PRIMARY KEY (rental_id),
  CONSTRAINT ebike_rentals_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT ebike_rentals_bike_id_fkey FOREIGN KEY (bike_id) REFERENCES public.ebikes(bike_id),
  CONSTRAINT ebike_rentals_start_station_id_fkey FOREIGN KEY (start_station_id) REFERENCES public.ebike_stations(station_id),
  CONSTRAINT ebike_rentals_end_station_id_fkey FOREIGN KEY (end_station_id) REFERENCES public.ebike_stations(station_id)
);
CREATE TABLE public.ebike_stations (
  station_id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  address text,
  gps_lat numeric NOT NULL,
  gps_lng numeric NOT NULL,
  total_slots integer DEFAULT 10,
  available_bikes integer DEFAULT 0,
  charging_bikes integer DEFAULT 0,
  maintenance_bikes integer DEFAULT 0,
  solar_capacity_kw numeric DEFAULT 0,
  current_energy_production_kw numeric DEFAULT 0,
  total_energy_generated_kwh numeric DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ebike_stations_pkey PRIMARY KEY (station_id)
);
CREATE TABLE public.ebikes (
  bike_id text NOT NULL,
  current_station_id uuid,
  status text DEFAULT 'available'::text CHECK (status = ANY (ARRAY['available'::text, 'in_use'::text, 'charging'::text, 'maintenance'::text, 'lost'::text])),
  battery_level integer DEFAULT 100 CHECK (battery_level >= 0 AND battery_level <= 100),
  gps_lat numeric,
  gps_lng numeric,
  last_gps_update timestamp with time zone,
  total_distance_km numeric DEFAULT 0,
  total_uses integer DEFAULT 0,
  current_rental_id uuid,
  current_user_id uuid,
  iot_device_id text,
  last_maintenance_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  bike_code text,
  is_locked boolean DEFAULT true,
  CONSTRAINT ebikes_pkey PRIMARY KEY (bike_id),
  CONSTRAINT ebikes_current_station_id_fkey FOREIGN KEY (current_station_id) REFERENCES public.ebike_stations(station_id),
  CONSTRAINT ebikes_current_user_id_fkey FOREIGN KEY (current_user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.eco_actions (
  action_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['borrow'::text, 'return'::text, 'checkin'::text, 'share'::text])),
  cup_id text,
  points integer DEFAULT 0,
  timestamp timestamp with time zone DEFAULT now(),
  description text NOT NULL,
  CONSTRAINT eco_actions_pkey PRIMARY KEY (action_id),
  CONSTRAINT eco_actions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.eco_impact_factors (
  factor_id uuid NOT NULL DEFAULT gen_random_uuid(),
  action_type character varying NOT NULL UNIQUE,
  co2_saved_kg_per_unit numeric NOT NULL,
  unit character varying NOT NULL,
  description text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT eco_impact_factors_pkey PRIMARY KEY (factor_id)
);
CREATE TABLE public.eco_points_transactions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  amount integer NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['earn_borrow'::text, 'earn_return'::text, 'earn_early_return'::text, 'earn_streak'::text, 'earn_referral'::text, 'earn_challenge'::text, 'earn_bonus'::text, 'spend_voucher'::text, 'spend_reward'::text, 'spend_donation'::text, 'admin_adjust'::text])),
  reference_id text,
  description text NOT NULL,
  balance_after integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT eco_points_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT eco_points_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.ekyc_verification_logs (
  log_id uuid NOT NULL DEFAULT gen_random_uuid(),
  verification_id uuid NOT NULL,
  action text NOT NULL,
  actor_id uuid,
  actor_type text,
  details jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ekyc_verification_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT ekyc_verification_logs_verification_id_fkey FOREIGN KEY (verification_id) REFERENCES public.ekyc_verifications(verification_id),
  CONSTRAINT ekyc_verification_logs_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.ekyc_verifications (
  verification_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  id_card_number text,
  full_name text,
  date_of_birth date,
  address text,
  id_card_issue_date date,
  id_card_issue_place text,
  front_image_url text,
  back_image_url text,
  face_image_url text,
  liveness_video_url text,
  verification_status text DEFAULT 'pending'::text CHECK (verification_status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'expired'::text, 'under_review'::text])),
  ai_match_score numeric CHECK (ai_match_score >= 0::numeric AND ai_match_score <= 100::numeric),
  ai_verification_data jsonb,
  admin_reviewed_by uuid,
  admin_notes text,
  reviewed_at timestamp with time zone,
  verified_at timestamp with time zone,
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ekyc_verifications_pkey PRIMARY KEY (verification_id),
  CONSTRAINT ekyc_verifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT ekyc_verifications_admin_reviewed_by_fkey FOREIGN KEY (admin_reviewed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.escrow_accounts (
  escrow_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  escrow_type text NOT NULL UNIQUE CHECK (escrow_type = ANY (ARRAY['cup_deposit'::text, 'transport_prepay'::text, 'ebike_deposit'::text, 'merchant_hold'::text])),
  total_balance numeric NOT NULL DEFAULT 0 CHECK (total_balance >= 0::numeric),
  transaction_count integer NOT NULL DEFAULT 0,
  last_updated timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT escrow_accounts_pkey PRIMARY KEY (escrow_id)
);
CREATE TABLE public.escrow_transactions (
  transaction_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  escrow_type text NOT NULL,
  user_id uuid NOT NULL,
  entry_type text NOT NULL CHECK (entry_type = ANY (ARRAY['hold'::text, 'release'::text, 'forfeit'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  reference_type text NOT NULL,
  reference_id uuid,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT escrow_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT escrow_transactions_escrow_type_fkey FOREIGN KEY (escrow_type) REFERENCES public.escrow_accounts(escrow_type),
  CONSTRAINT escrow_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.feedbacks (
  feedback_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['complaint'::text, 'suggestion'::text, 'lost_cup'::text, 'broken_cup'::text, 'app_bug'::text, 'other'::text])),
  subject text,
  content text NOT NULL,
  image_urls ARRAY,
  cup_id text,
  transaction_id uuid,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'reviewing'::text, 'resolved'::text, 'rejected'::text, 'in_progress'::text])),
  priority text DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['low'::text, 'normal'::text, 'high'::text, 'urgent'::text])),
  admin_notes text,
  admin_response text,
  resolved_by uuid,
  resolved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feedbacks_pkey PRIMARY KEY (feedback_id),
  CONSTRAINT feedbacks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.friend_requests (
  request_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  from_user_id uuid NOT NULL,
  to_user_id uuid NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'accepted'::text, 'rejected'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT friend_requests_pkey PRIMARY KEY (request_id),
  CONSTRAINT friend_requests_from_user_id_fkey FOREIGN KEY (from_user_id) REFERENCES public.users(user_id),
  CONSTRAINT friend_requests_to_user_id_fkey FOREIGN KEY (to_user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.friendships (
  friendship_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id_1 uuid NOT NULL,
  user_id_2 uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT friendships_pkey PRIMARY KEY (friendship_id),
  CONSTRAINT friendships_user_id_1_fkey FOREIGN KEY (user_id_1) REFERENCES public.users(user_id),
  CONSTRAINT friendships_user_id_2_fkey FOREIGN KEY (user_id_2) REFERENCES public.users(user_id)
);
CREATE TABLE public.game_scores (
  score_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  game_type text,
  score integer NOT NULL,
  reward integer DEFAULT 0,
  metadata jsonb,
  played_at timestamp with time zone DEFAULT now(),
  CONSTRAINT game_scores_pkey PRIMARY KEY (score_id),
  CONSTRAINT game_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.green_credit_history (
  history_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  action text NOT NULL,
  score_change integer NOT NULL,
  old_score integer NOT NULL,
  new_score integer NOT NULL,
  reason text,
  related_resource_type text,
  related_resource_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT green_credit_history_pkey PRIMARY KEY (history_id),
  CONSTRAINT green_credit_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.green_feed_posts (
  post_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  display_name text,
  avatar text,
  image_url text,
  caption text,
  cup_id text,
  green_points_earned integer DEFAULT 0,
  likes integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  post_type text DEFAULT 'normal'::text,
  achievement_type text,
  location text,
  carbon_saved numeric DEFAULT 0,
  emotion text,
  content text NOT NULL DEFAULT ''::text,
  CONSTRAINT green_feed_posts_pkey PRIMARY KEY (post_id),
  CONSTRAINT green_feed_posts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.green_mobility_trips (
  trip_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  trip_type text NOT NULL CHECK (trip_type = ANY (ARRAY['bus'::text, 'metro'::text, 'ebike'::text])),
  transport_partner_id uuid,
  start_time timestamp with time zone NOT NULL DEFAULT now(),
  end_time timestamp with time zone,
  distance_km numeric,
  fare numeric NOT NULL,
  commission_amount numeric DEFAULT 0,
  partner_amount numeric DEFAULT 0,
  co2_saved_kg numeric DEFAULT 0,
  vnes_points_earned integer DEFAULT 0,
  status text DEFAULT 'ongoing'::text CHECK (status = ANY (ARRAY['ongoing'::text, 'completed'::text, 'cancelled'::text])),
  route_info jsonb,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT green_mobility_trips_pkey PRIMARY KEY (trip_id),
  CONSTRAINT green_mobility_trips_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT green_mobility_trips_transport_partner_id_fkey FOREIGN KEY (transport_partner_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.incidents (
  incident_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  type text,
  cup_id text,
  user_id uuid,
  store_id uuid,
  description text,
  status text DEFAULT 'open'::text,
  priority text DEFAULT 'medium'::text,
  assigned_to uuid,
  resolution text,
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT incidents_pkey PRIMARY KEY (incident_id),
  CONSTRAINT incidents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT incidents_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id),
  CONSTRAINT incidents_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.leaderboard (
  entry_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  display_name text NOT NULL,
  avatar text,
  green_points integer DEFAULT 0,
  total_cups_saved integer DEFAULT 0,
  rank integer NOT NULL,
  department text,
  class text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT leaderboard_pkey PRIMARY KEY (entry_id),
  CONSTRAINT leaderboard_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.membership_plans (
  plan_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  price numeric NOT NULL,
  duration_days integer NOT NULL DEFAULT 30,
  benefits jsonb DEFAULT '{}'::jsonb,
  max_active_borrows integer DEFAULT 3,
  priority_level integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT membership_plans_pkey PRIMARY KEY (plan_id)
);
CREATE TABLE public.merchant_accounts (
  account_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  store_id uuid NOT NULL,
  user_id uuid,
  role text DEFAULT 'staff'::text CHECK (role = ANY (ARRAY['owner'::text, 'manager'::text, 'staff'::text])),
  pin_code text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT merchant_accounts_pkey PRIMARY KEY (account_id),
  CONSTRAINT merchant_accounts_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id),
  CONSTRAINT merchant_accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.message_reactions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  message_id uuid NOT NULL,
  user_id uuid NOT NULL,
  emoji text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT message_reactions_pkey PRIMARY KEY (id),
  CONSTRAINT message_reactions_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.messages(message_id)
);
CREATE TABLE public.messages (
  message_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid NOT NULL,
  sender_id uuid NOT NULL,
  type text NOT NULL DEFAULT 'text'::text CHECK (type = ANY (ARRAY['text'::text, 'image'::text, 'sticker'::text, 'video'::text, 'voucher'::text, 'borrow_request'::text, 'system'::text])),
  content text,
  metadata jsonb,
  is_deleted boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  media_url text,
  CONSTRAINT messages_pkey PRIMARY KEY (message_id),
  CONSTRAINT messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(conversation_id),
  CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.notification_recipients (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  notification_id uuid NOT NULL,
  user_id uuid NOT NULL,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_recipients_pkey PRIMARY KEY (id),
  CONSTRAINT notification_recipients_notification_id_fkey FOREIGN KEY (notification_id) REFERENCES public.system_notifications(notification_id),
  CONSTRAINT notification_recipients_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.notification_templates (
  template_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code text NOT NULL UNIQUE,
  title text NOT NULL,
  message text NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['reminder'::text, 'promotion'::text, 'system'::text, 'achievement'::text, 'social'::text])),
  channel text DEFAULT 'push'::text CHECK (channel = ANY (ARRAY['push'::text, 'email'::text, 'sms'::text, 'in_app'::text, 'zalo'::text, 'telegram'::text])),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  category text DEFAULT 'general'::text,
  CONSTRAINT notification_templates_pkey PRIMARY KEY (template_id)
);
CREATE TABLE public.notifications (
  notification_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['success'::text, 'warning'::text, 'info'::text, 'reminder'::text])),
  title text NOT NULL,
  message text NOT NULL,
  url text,
  data jsonb,
  read boolean DEFAULT false,
  timestamp timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.partner_activity_log (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid,
  user_id uuid,
  branch_id uuid,
  action text NOT NULL,
  entity_type text,
  entity_id text,
  old_data jsonb,
  new_data jsonb,
  ip_address text,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_activity_log_pkey PRIMARY KEY (log_id),
  CONSTRAINT partner_activity_log_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_activity_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.partner_users(user_id),
  CONSTRAINT partner_activity_log_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.partner_branches(branch_id)
);
CREATE TABLE public.partner_branches (
  branch_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  store_id uuid,
  name text NOT NULL,
  code text,
  address text,
  phone text,
  manager_name text,
  latitude numeric,
  longitude numeric,
  operating_hours jsonb,
  config jsonb DEFAULT '{}'::jsonb,
  cup_capacity integer DEFAULT 50,
  current_clean_cups integer DEFAULT 0,
  current_dirty_cups integer DEFAULT 0,
  accepts_borrow boolean DEFAULT true,
  accepts_return boolean DEFAULT true,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_branches_pkey PRIMARY KEY (branch_id),
  CONSTRAINT partner_branches_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_branches_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.partner_categories (
  cat_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  icon text,
  features_config jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_categories_pkey PRIMARY KEY (cat_id)
);
CREATE TABLE public.partner_contracts (
  contract_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  store_id uuid NOT NULL,
  contract_type text NOT NULL CHECK (contract_type = ANY (ARRAY['revenue_share'::text, 'fixed_fee'::text, 'hybrid'::text])),
  commission_rate numeric DEFAULT 0,
  fixed_fee numeric DEFAULT 0,
  start_date date NOT NULL,
  end_date date,
  document_url text,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'active'::text, 'expired'::text, 'terminated'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  handling_fee_per_scan numeric DEFAULT 200,
  plastic_saving_unit_price numeric DEFAULT 1500,
  cup_rental_fee numeric DEFAULT 0,
  min_monthly_transactions integer DEFAULT 0,
  CONSTRAINT partner_contracts_pkey PRIMARY KEY (contract_id),
  CONSTRAINT partner_contracts_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.partner_ledger (
  ledger_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  entry_type text NOT NULL CHECK (entry_type = ANY (ARRAY['credit'::text, 'debit'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  balance_before numeric NOT NULL DEFAULT 0,
  balance_after numeric NOT NULL DEFAULT 0,
  reference_type text NOT NULL CHECK (reference_type = ANY (ARRAY['commission'::text, 'settlement_payout'::text, 'adjustment'::text, 'refund_deduction'::text])),
  reference_id uuid,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_ledger_pkey PRIMARY KEY (ledger_id),
  CONSTRAINT partner_ledger_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partner_wallets(partner_id)
);
CREATE TABLE public.partner_payouts (
  payout_id uuid NOT NULL DEFAULT gen_random_uuid(),
  partner_id uuid NOT NULL,
  payout_period_start timestamp with time zone NOT NULL,
  payout_period_end timestamp with time zone NOT NULL,
  total_revenue numeric NOT NULL DEFAULT 0,
  commission_deducted numeric DEFAULT 0,
  transaction_count integer DEFAULT 0,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])),
  bank_transfer_reference text,
  bank_transfer_fee numeric DEFAULT 0,
  net_payout numeric,
  processed_by uuid,
  processed_at timestamp with time zone,
  paid_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_payouts_pkey PRIMARY KEY (payout_id),
  CONSTRAINT partner_payouts_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.stores(store_id),
  CONSTRAINT partner_payouts_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.users(user_id)
);
CREATE TABLE public.partner_qr_codes (
  qr_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  store_id uuid,
  qr_code text NOT NULL UNIQUE,
  qr_type text DEFAULT 'both'::text CHECK (qr_type = ANY (ARRAY['borrow'::text, 'return'::text, 'both'::text])),
  name text NOT NULL,
  description text,
  is_active boolean DEFAULT true,
  scan_count integer DEFAULT 0,
  last_scanned_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_qr_codes_pkey PRIMARY KEY (qr_id),
  CONSTRAINT partner_qr_codes_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_qr_codes_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.partner_revenue_logs (
  log_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid,
  branch_id uuid,
  report_month integer NOT NULL CHECK (report_month >= 1 AND report_month <= 12),
  report_year integer NOT NULL CHECK (report_year >= 2020),
  total_scans integer DEFAULT 0,
  total_borrows integer DEFAULT 0,
  total_returns integer DEFAULT 0,
  handling_fee_earned numeric DEFAULT 0,
  plastic_saving_value numeric DEFAULT 0,
  subscription_fee_paid numeric DEFAULT 0,
  commission_paid numeric DEFAULT 0,
  net_profit numeric DEFAULT 0,
  cups_reused integer DEFAULT 0,
  plastic_saved_grams integer DEFAULT 0,
  co2_saved_grams integer DEFAULT 0,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'confirmed'::text, 'disputed'::text])),
  confirmed_by uuid,
  confirmed_at timestamp with time zone,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_revenue_logs_pkey PRIMARY KEY (log_id),
  CONSTRAINT partner_revenue_logs_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_revenue_logs_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.partner_branches(branch_id),
  CONSTRAINT partner_revenue_logs_confirmed_by_fkey FOREIGN KEY (confirmed_by) REFERENCES public.partner_users(user_id)
);
CREATE TABLE public.partner_roles (
  role_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  description text,
  permissions jsonb DEFAULT '{}'::jsonb,
  level integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_roles_pkey PRIMARY KEY (role_id)
);
CREATE TABLE public.partner_stores (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  store_id uuid NOT NULL,
  access_level text DEFAULT 'view'::text CHECK (access_level = ANY (ARRAY['view'::text, 'manage'::text, 'full'::text])),
  granted_at timestamp with time zone DEFAULT now(),
  granted_by uuid,
  CONSTRAINT partner_stores_pkey PRIMARY KEY (id),
  CONSTRAINT partner_stores_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners(partner_id),
  CONSTRAINT partner_stores_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.partner_users (
  user_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  branch_id uuid,
  role_id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  password_hash text NOT NULL,
  display_name text NOT NULL,
  phone text,
  avatar_url text,
  is_active boolean DEFAULT true,
  last_login timestamp with time zone,
  login_count integer DEFAULT 0,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT partner_users_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_users_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.partner_branches(branch_id),
  CONSTRAINT partner_users_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.partner_roles(role_id)
);
CREATE TABLE public.partner_vouchers (
  voucher_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  branch_id uuid,
  code text NOT NULL,
  name text NOT NULL,
  description text,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percent'::text, 'fixed'::text, 'free_item'::text])),
  discount_value numeric NOT NULL,
  min_order_value numeric DEFAULT 0,
  max_discount numeric,
  usage_limit integer,
  usage_count integer DEFAULT 0,
  per_user_limit integer DEFAULT 1,
  valid_from timestamp with time zone DEFAULT now(),
  valid_until timestamp with time zone,
  requires_eco_cup boolean DEFAULT true,
  eco_points_required integer DEFAULT 0,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'pending_approval'::text, 'active'::text, 'paused'::text, 'expired'::text])),
  approved_by uuid,
  approved_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_vouchers_pkey PRIMARY KEY (voucher_id),
  CONSTRAINT partner_vouchers_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id),
  CONSTRAINT partner_vouchers_branch_id_fkey FOREIGN KEY (branch_id) REFERENCES public.partner_branches(branch_id),
  CONSTRAINT partner_vouchers_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.partner_users(user_id)
);
CREATE TABLE public.partner_wallets (
  partner_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_type text NOT NULL CHECK (partner_type = ANY (ARRAY['store'::text, 'transport'::text, 'ebike'::text, 'merchant'::text])),
  partner_name text NOT NULL,
  email text UNIQUE,
  phone text,
  balance numeric NOT NULL DEFAULT 0 CHECK (balance >= 0::numeric),
  pending_settlement numeric NOT NULL DEFAULT 0 CHECK (pending_settlement >= 0::numeric),
  total_earned numeric NOT NULL DEFAULT 0,
  commission_rate numeric NOT NULL DEFAULT 0.001,
  bank_account jsonb DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'pending_verification'::text])),
  verified_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partner_wallets_pkey PRIMARY KEY (partner_id)
);
CREATE TABLE public.partners (
  partner_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email text NOT NULL UNIQUE,
  password_hash text NOT NULL,
  name text NOT NULL,
  phone text,
  role text DEFAULT 'store_manager'::text CHECK (role = ANY (ARRAY['store_manager'::text, 'regional_manager'::text, 'owner'::text])),
  is_active boolean DEFAULT true,
  last_login timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partners_pkey PRIMARY KEY (partner_id)
);
CREATE TABLE public.partners_v2 (
  partner_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  legal_name text,
  tax_code text,
  category_id uuid,
  logo_url text,
  contact_email text,
  contact_phone text,
  address text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'suspended'::text, 'terminated'::text])),
  contract_start_date date,
  contract_end_date date,
  settings jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partners_v2_pkey PRIMARY KEY (partner_id),
  CONSTRAINT partners_v2_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.partner_categories(cat_id)
);
CREATE TABLE public.payment_configs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  provider_id text NOT NULL UNIQUE,
  provider_name text NOT NULL,
  logo_url text,
  is_active boolean DEFAULT false,
  is_sandbox boolean DEFAULT true,
  display_order integer DEFAULT 0,
  min_amount numeric DEFAULT 10000,
  max_amount numeric DEFAULT 100000000,
  fee_percent numeric DEFAULT 0,
  fee_fixed numeric DEFAULT 0,
  config_data jsonb DEFAULT '{}'::jsonb,
  bank_accounts jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_configs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_methods (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  type text NOT NULL,
  provider text NOT NULL,
  account_number text,
  account_name text,
  is_default boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT payment_methods_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.payment_settings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  provider_name character varying NOT NULL,
  config_key character varying NOT NULL,
  config_value text NOT NULL,
  config_value_encrypted bytea,
  is_sensitive boolean DEFAULT false,
  is_active boolean DEFAULT true,
  description text,
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_settings_pkey PRIMARY KEY (id),
  CONSTRAINT payment_settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.payment_settings_audit (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  setting_id uuid,
  provider_name character varying NOT NULL,
  config_key character varying NOT NULL,
  old_value_masked character varying,
  new_value_masked character varying,
  action character varying NOT NULL,
  changed_by uuid,
  changed_at timestamp with time zone DEFAULT now(),
  ip_address character varying,
  user_agent text,
  CONSTRAINT payment_settings_audit_pkey PRIMARY KEY (id),
  CONSTRAINT payment_settings_audit_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id),
  CONSTRAINT payment_settings_audit_setting_id_fkey FOREIGN KEY (setting_id) REFERENCES public.payment_settings(id)
);
CREATE TABLE public.payment_transactions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  type text NOT NULL,
  amount numeric NOT NULL,
  payment_method text,
  transaction_code text UNIQUE,
  status text DEFAULT 'pending'::text,
  description text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  vnpay_txn_ref text,
  vnpay_response_code text,
  external_transaction_id text,
  error_message text,
  ip_address text,
  provider_id text DEFAULT 'VNPAY'::text,
  CONSTRAINT payment_transactions_pkey PRIMARY KEY (id),
  CONSTRAINT payment_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.post_likes (
  like_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  post_id uuid NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT post_likes_pkey PRIMARY KEY (like_id),
  CONSTRAINT post_likes_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.green_feed_posts(post_id),
  CONSTRAINT post_likes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.redistribution_orders (
  order_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  from_store_id uuid,
  to_store_id uuid,
  cup_count integer NOT NULL CHECK (cup_count > 0),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_transit'::text, 'completed'::text, 'cancelled'::text])),
  priority text DEFAULT 'medium'::text CHECK (priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT redistribution_orders_pkey PRIMARY KEY (order_id),
  CONSTRAINT redistribution_orders_from_store_id_fkey FOREIGN KEY (from_store_id) REFERENCES public.stores(store_id),
  CONSTRAINT redistribution_orders_to_store_id_fkey FOREIGN KEY (to_store_id) REFERENCES public.stores(store_id),
  CONSTRAINT redistribution_orders_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.reward_claims (
  claim_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  reward_id uuid,
  points_used integer NOT NULL,
  status text DEFAULT 'pending'::text,
  claimed_at timestamp with time zone DEFAULT now(),
  used_at timestamp with time zone,
  claim_code text UNIQUE,
  CONSTRAINT reward_claims_pkey PRIMARY KEY (claim_id),
  CONSTRAINT reward_claims_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT reward_claims_reward_id_fkey FOREIGN KEY (reward_id) REFERENCES public.rewards(reward_id)
);
CREATE TABLE public.rewards (
  reward_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  description text,
  image text,
  points_cost integer NOT NULL,
  stock integer DEFAULT 0,
  category text,
  valid_until timestamp with time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT rewards_pkey PRIMARY KEY (reward_id)
);
CREATE TABLE public.settlement_batches (
  batch_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  partner_id uuid NOT NULL,
  period_start date NOT NULL,
  period_end date NOT NULL,
  total_transactions integer NOT NULL DEFAULT 0,
  gross_amount numeric NOT NULL DEFAULT 0,
  commission_amount numeric NOT NULL DEFAULT 0,
  net_amount numeric NOT NULL DEFAULT 0,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'processing'::text, 'paid'::text, 'failed'::text, 'cancelled'::text])),
  approved_by uuid,
  approved_at timestamp with time zone,
  paid_at timestamp with time zone,
  payment_reference text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT settlement_batches_pkey PRIMARY KEY (batch_id),
  CONSTRAINT settlement_batches_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partner_wallets(partner_id),
  CONSTRAINT settlement_batches_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.settlements (
  settlement_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  store_id uuid NOT NULL,
  period_start date NOT NULL,
  period_end date NOT NULL,
  total_transactions integer DEFAULT 0,
  total_revenue numeric DEFAULT 0,
  commission_amount numeric DEFAULT 0,
  fixed_fee numeric DEFAULT 0,
  net_payable numeric DEFAULT 0,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'paid'::text])),
  approved_by uuid,
  paid_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  notes text,
  CONSTRAINT settlements_pkey PRIMARY KEY (settlement_id),
  CONSTRAINT settlements_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id),
  CONSTRAINT settlements_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.smart_devices (
  device_id uuid NOT NULL DEFAULT gen_random_uuid(),
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['hand_dryer'::character varying, 'charging_station'::character varying, 'cup_dispenser'::character varying, 'solar_kiosk'::character varying]::text[])),
  name character varying,
  location_id uuid,
  qr_code character varying UNIQUE,
  energy_source character varying DEFAULT 'grid'::character varying,
  status character varying DEFAULT 'active'::character varying,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT smart_devices_pkey PRIMARY KEY (device_id),
  CONSTRAINT smart_devices_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.partner_branches(branch_id)
);
CREATE TABLE public.store_cup_alerts (
  alert_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  store_id uuid,
  alert_type text CHECK (alert_type = ANY (ARRAY['low_stock'::text, 'excess_stock'::text])),
  current_count integer,
  threshold integer,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT store_cup_alerts_pkey PRIMARY KEY (alert_id),
  CONSTRAINT store_cup_alerts_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(store_id)
);
CREATE TABLE public.stores (
  store_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  gps_lat numeric NOT NULL,
  gps_lng numeric NOT NULL,
  address text NOT NULL,
  cup_available integer DEFAULT 0,
  cup_in_use integer DEFAULT 0,
  cup_cleaning integer DEFAULT 0,
  cup_total integer DEFAULT 0,
  partner_status text DEFAULT 'active'::text CHECK (partner_status = ANY (ARRAY['active'::text, 'inactive'::text, 'pending'::text])),
  created_at timestamp with time zone DEFAULT now(),
  partner_id uuid,
  partner_type text DEFAULT 'retail'::text CHECK (partner_type = ANY (ARRAY['retail'::text, 'transport'::text, 'ebike_station'::text])),
  transport_revenue numeric DEFAULT 0,
  total_co2_saved_kg numeric DEFAULT 0,
  bank_account_number text,
  bank_name text,
  bank_account_holder text,
  tax_code text,
  business_license text,
  auto_payout_enabled boolean DEFAULT false,
  CONSTRAINT stores_pkey PRIMARY KEY (store_id),
  CONSTRAINT stores_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners_v2(partner_id)
);
CREATE TABLE public.stories (
  story_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  display_name text,
  avatar text,
  type text NOT NULL CHECK (type = ANY (ARRAY['image'::text, 'video'::text, 'achievement'::text, 'milestone'::text])),
  content text NOT NULL,
  thumbnail text,
  achievement_type text CHECK (achievement_type = ANY (ARRAY['cup_saved'::text, 'points'::text, 'rank_up'::text, 'challenge'::text])),
  achievement_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'pending'::text, 'archived'::text])),
  CONSTRAINT stories_pkey PRIMARY KEY (story_id),
  CONSTRAINT stories_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.story_views (
  view_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  story_id uuid NOT NULL,
  user_id uuid NOT NULL,
  viewed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT story_views_pkey PRIMARY KEY (view_id),
  CONSTRAINT story_views_story_id_fkey FOREIGN KEY (story_id) REFERENCES public.stories(story_id),
  CONSTRAINT story_views_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.sustainability_metrics (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  period text NOT NULL CHECK (period = ANY (ARRAY['daily'::text, 'weekly'::text, 'monthly'::text, 'yearly'::text])),
  period_start timestamp with time zone NOT NULL,
  period_end timestamp with time zone NOT NULL,
  cups_reused integer DEFAULT 0 CHECK (cups_reused >= 0),
  plastic_saved_grams integer DEFAULT 0 CHECK (plastic_saved_grams >= 0),
  co2_saved_grams integer DEFAULT 0 CHECK (co2_saved_grams >= 0),
  water_saved_liters numeric DEFAULT 0 CHECK (water_saved_liters >= 0::numeric),
  active_users integer DEFAULT 0 CHECK (active_users >= 0),
  new_users integer DEFAULT 0 CHECK (new_users >= 0),
  total_transactions integer DEFAULT 0 CHECK (total_transactions >= 0),
  on_time_returns integer DEFAULT 0 CHECK (on_time_returns >= 0),
  overdue_returns integer DEFAULT 0 CHECK (overdue_returns >= 0),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sustainability_metrics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_notifications (
  notification_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  admin_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['info'::text, 'warning'::text, 'promotion'::text, 'maintenance'::text, 'event'::text])),
  title text NOT NULL,
  message text NOT NULL,
  image_url text,
  action_url text,
  target_audience text DEFAULT 'all'::text CHECK (target_audience = ANY (ARRAY['all'::text, 'active'::text, 'inactive'::text, 'new'::text, 'premium'::text])),
  target_rank text CHECK (target_rank = ANY (ARRAY['seed'::text, 'sprout'::text, 'sapling'::text, 'tree'::text, 'forest'::text])),
  priority integer DEFAULT 0,
  is_active boolean DEFAULT true,
  start_at timestamp with time zone DEFAULT now(),
  end_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  content_html text,
  emoji text,
  attachments jsonb,
  template_id uuid,
  recipients_count integer DEFAULT 0,
  read_count integer DEFAULT 0,
  CONSTRAINT system_notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT system_notifications_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.system_settings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  key text NOT NULL UNIQUE,
  value text,
  data_type text,
  category text,
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  description text,
  CONSTRAINT system_settings_pkey PRIMARY KEY (id),
  CONSTRAINT system_settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.transactions (
  transaction_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  cup_id text NOT NULL,
  borrow_store_id uuid NOT NULL,
  return_store_id uuid,
  borrow_time timestamp with time zone DEFAULT now(),
  due_time timestamp with time zone NOT NULL,
  return_time timestamp with time zone,
  status text DEFAULT 'ongoing'::text CHECK (status = ANY (ARRAY['ongoing'::text, 'completed'::text, 'overdue'::text, 'cancelled'::text])),
  deposit_amount numeric NOT NULL,
  refund_amount numeric,
  green_points_earned integer,
  is_overdue boolean DEFAULT false,
  overdue_hours integer,
  CONSTRAINT transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT transactions_cup_id_fkey FOREIGN KEY (cup_id) REFERENCES public.cups(cup_id)
);
CREATE TABLE public.transport_trips (
  trip_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  vehicle_id uuid,
  start_time timestamp with time zone DEFAULT now(),
  end_time timestamp with time zone,
  start_lat double precision,
  start_lng double precision,
  end_lat double precision,
  end_lng double precision,
  distance_km numeric DEFAULT 0,
  fare_amount numeric DEFAULT 0,
  commission_amount numeric DEFAULT 0,
  co2_saved_kg numeric DEFAULT 0,
  status character varying DEFAULT 'ongoing'::character varying,
  payment_status character varying DEFAULT 'pending'::character varying,
  CONSTRAINT transport_trips_pkey PRIMARY KEY (trip_id),
  CONSTRAINT transport_trips_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT transport_trips_vehicle_id_fkey FOREIGN KEY (vehicle_id) REFERENCES public.transport_vehicles(vehicle_id)
);
CREATE TABLE public.transport_vehicles (
  vehicle_id uuid NOT NULL DEFAULT gen_random_uuid(),
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['ebus'::character varying, 'ebike'::character varying]::text[])),
  code character varying NOT NULL UNIQUE,
  qr_code character varying UNIQUE,
  current_lat double precision,
  current_lng double precision,
  battery_level integer DEFAULT 100,
  status character varying DEFAULT 'active'::character varying,
  last_maintenance timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT transport_vehicles_pkey PRIMARY KEY (vehicle_id)
);
CREATE TABLE public.typing_indicators (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid NOT NULL,
  user_id uuid NOT NULL,
  started_at timestamp with time zone DEFAULT now(),
  CONSTRAINT typing_indicators_pkey PRIMARY KEY (id),
  CONSTRAINT typing_indicators_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(conversation_id)
);
CREATE TABLE public.user_achievements (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  achievement_id uuid,
  unlocked_at timestamp with time zone DEFAULT now(),
  progress integer DEFAULT 0,
  CONSTRAINT user_achievements_pkey PRIMARY KEY (id),
  CONSTRAINT user_achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT user_achievements_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievements(achievement_id)
);
CREATE TABLE public.user_badges (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  badge_id uuid NOT NULL,
  achieved_at timestamp with time zone DEFAULT now(),
  notified boolean DEFAULT false,
  CONSTRAINT user_badges_pkey PRIMARY KEY (id),
  CONSTRAINT user_badges_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT user_badges_badge_id_fkey FOREIGN KEY (badge_id) REFERENCES public.badges(badge_id)
);
CREATE TABLE public.user_challenges (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  challenge_id uuid,
  progress integer DEFAULT 0,
  completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  joined_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['in_progress'::text, 'completed'::text, 'failed'::text])),
  CONSTRAINT user_challenges_pkey PRIMARY KEY (id),
  CONSTRAINT user_challenges_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT user_challenges_challenge_id_fkey FOREIGN KEY (challenge_id) REFERENCES public.challenges(challenge_id)
);
CREATE TABLE public.user_green_streaks (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  current_streak integer DEFAULT 0 CHECK (current_streak >= 0),
  longest_streak integer DEFAULT 0 CHECK (longest_streak >= 0),
  last_activity_date date,
  streak_started_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_green_streaks_pkey PRIMARY KEY (id),
  CONSTRAINT user_green_streaks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.user_kyc (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  id_number character varying,
  full_name character varying,
  dob date,
  gender character varying,
  nationality character varying DEFAULT 'Vit Nam'::character varying,
  place_of_origin text,
  place_of_residence text,
  front_img_path text,
  back_img_path text,
  selfie_img_path text,
  status character varying DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'pending'::character varying, 'verified'::character varying, 'rejected'::character varying]::text[])),
  rejection_reason text,
  ocr_front_data jsonb,
  ocr_back_data jsonb,
  ocr_confidence numeric,
  submitted_at timestamp with time zone,
  verified_at timestamp with time zone,
  verified_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_kyc_pkey PRIMARY KEY (id),
  CONSTRAINT user_kyc_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_kyc_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES auth.users(id)
);
CREATE TABLE public.user_memberships (
  membership_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  plan_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'cancelled'::text, 'pending'::text])),
  start_date timestamp with time zone NOT NULL DEFAULT now(),
  end_date timestamp with time zone NOT NULL,
  auto_renew boolean DEFAULT false,
  payment_method text,
  payment_ref text,
  cancelled_at timestamp with time zone,
  cancel_reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_memberships_pkey PRIMARY KEY (membership_id),
  CONSTRAINT user_memberships_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT user_memberships_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.membership_plans(plan_id)
);
CREATE TABLE public.user_notifications (
  notification_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  template_code text,
  type text NOT NULL CHECK (type = ANY (ARRAY['reminder'::text, 'promotion'::text, 'system'::text, 'achievement'::text, 'social'::text])),
  title text NOT NULL,
  message text NOT NULL,
  data jsonb DEFAULT '{}'::jsonb,
  channel text DEFAULT 'in_app'::text CHECK (channel = ANY (ARRAY['push'::text, 'email'::text, 'sms'::text, 'in_app'::text, 'zalo'::text, 'telegram'::text])),
  is_read boolean DEFAULT false,
  is_sent boolean DEFAULT false,
  sent_at timestamp with time zone,
  read_at timestamp with time zone,
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT user_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.user_presence (
  user_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'offline'::text CHECK (status = ANY (ARRAY['online'::text, 'offline'::text, 'away'::text, 'busy'::text])),
  last_seen_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_presence_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.user_vouchers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  voucher_id uuid NOT NULL,
  claimed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_vouchers_pkey PRIMARY KEY (id),
  CONSTRAINT user_vouchers_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.users (
  user_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  student_id text UNIQUE,
  email text NOT NULL UNIQUE,
  display_name text,
  avatar text,
  wallet_balance numeric DEFAULT 0,
  green_points integer DEFAULT 0,
  rank_level text DEFAULT 'seed'::text CHECK (rank_level = ANY (ARRAY['seed'::text, 'sprout'::text, 'sapling'::text, 'tree'::text, 'forest'::text])),
  total_cups_saved integer DEFAULT 0,
  total_plastic_reduced integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  last_activity timestamp with time zone DEFAULT now(),
  is_blacklisted boolean DEFAULT false,
  blacklist_reason text,
  blacklist_count integer DEFAULT 0,
  green_streak integer NOT NULL DEFAULT 0,
  last_return_date timestamp without time zone,
  best_streak integer NOT NULL DEFAULT 0,
  updated_at timestamp with time zone DEFAULT now(),
  bio text,
  is_email_public boolean DEFAULT false,
  is_student_id_public boolean DEFAULT false,
  zalo_user_id text,
  telegram_chat_id text,
  notification_preferences jsonb DEFAULT '{"push": true, "zalo": false, "email": false, "telegram": false}'::jsonb,
  green_credit_score integer DEFAULT 100 CHECK (green_credit_score >= 0 AND green_credit_score <= 1000),
  ekyc_verified boolean DEFAULT false,
  ekyc_verified_at timestamp with time zone,
  ekyc_expires_at timestamp with time zone,
  wallet_frozen boolean DEFAULT false,
  wallet_frozen_at timestamp with time zone,
  wallet_frozen_reason text,
  daily_withdrawal_limit numeric DEFAULT 5000000,
  monthly_withdrawal_limit numeric DEFAULT 50000000,
  kyc_verified boolean DEFAULT false,
  kyc_status character varying DEFAULT 'none'::character varying,
  role character varying DEFAULT 'user'::character varying,
  full_name text,
  phone_number character varying,
  address text,
  province text,
  is_profile_public boolean DEFAULT true,
  CONSTRAINT users_pkey PRIMARY KEY (user_id)
);
CREATE TABLE public.virtual_trees (
  tree_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL UNIQUE,
  level integer DEFAULT 1 CHECK (level >= 1 AND level <= 10),
  growth numeric DEFAULT 0 CHECK (growth >= 0::numeric AND growth <= 100::numeric),
  health text DEFAULT 'healthy'::text CHECK (health = ANY (ARRAY['healthy'::text, 'wilting'::text, 'dead'::text])),
  last_watered timestamp with time zone DEFAULT now(),
  total_waterings integer DEFAULT 0,
  CONSTRAINT virtual_trees_pkey PRIMARY KEY (tree_id),
  CONSTRAINT virtual_trees_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.voucher_claims (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  voucher_id uuid NOT NULL,
  user_id uuid NOT NULL,
  transaction_id uuid,
  discount_applied numeric NOT NULL CHECK (discount_applied >= 0::numeric),
  status text DEFAULT 'claimed'::text CHECK (status = ANY (ARRAY['claimed'::text, 'used'::text, 'expired'::text, 'refunded'::text])),
  claimed_at timestamp with time zone DEFAULT now(),
  used_at timestamp with time zone,
  CONSTRAINT voucher_claims_pkey PRIMARY KEY (id),
  CONSTRAINT voucher_claims_voucher_id_fkey FOREIGN KEY (voucher_id) REFERENCES public.vouchers(voucher_id),
  CONSTRAINT voucher_claims_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT voucher_claims_transaction_id_fkey FOREIGN KEY (transaction_id) REFERENCES public.transactions(transaction_id)
);
CREATE TABLE public.voucher_usage (
  usage_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  voucher_id uuid NOT NULL,
  user_id uuid NOT NULL,
  order_id uuid,
  order_type text CHECK (order_type = ANY (ARRAY['reward_claim'::text, 'topup'::text, 'other'::text])),
  original_amount numeric NOT NULL,
  discount_amount numeric NOT NULL CHECK (discount_amount >= 0::numeric),
  final_amount numeric NOT NULL CHECK (final_amount >= 0::numeric),
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT voucher_usage_pkey PRIMARY KEY (usage_id),
  CONSTRAINT voucher_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.vouchers (
  voucher_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percent'::text, 'fixed'::text, 'free_deposit'::text, 'eco_points'::text])),
  discount_value numeric NOT NULL CHECK (discount_value >= 0::numeric),
  min_borrow_count integer DEFAULT 0,
  max_discount numeric,
  total_quantity integer NOT NULL CHECK (total_quantity > 0),
  used_quantity integer DEFAULT 0 CHECK (used_quantity >= 0),
  start_date timestamp with time zone NOT NULL,
  expiry_date timestamp with time zone NOT NULL,
  target_group text DEFAULT 'all'::text CHECK (target_group = ANY (ARRAY['all'::text, 'new_users'::text, 'top_users'::text, 'eco_champions'::text, 'specific'::text])),
  target_user_ids jsonb,
  eco_points_cost integer CHECK (eco_points_cost >= 0),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT vouchers_pkey PRIMARY KEY (voucher_id),
  CONSTRAINT vouchers_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.wallet_audit_log (
  audit_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['freeze'::text, 'unfreeze'::text, 'manual_adjustment'::text, 'balance_correction'::text])),
  old_value jsonb,
  new_value jsonb,
  reason text NOT NULL,
  performed_by uuid NOT NULL,
  ip_address inet,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT wallet_audit_log_pkey PRIMARY KEY (audit_id),
  CONSTRAINT wallet_audit_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id),
  CONSTRAINT wallet_audit_log_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.admins(admin_id)
);
CREATE TABLE public.wallet_ledger (
  ledger_id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  entry_type text NOT NULL CHECK (entry_type = ANY (ARRAY['credit'::text, 'debit'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  balance_before numeric NOT NULL DEFAULT 0,
  balance_after numeric NOT NULL DEFAULT 0,
  reference_type text NOT NULL CHECK (reference_type = ANY (ARRAY['topup'::text, 'withdrawal'::text, 'deposit'::text, 'refund'::text, 'fee'::text, 'reward'::text, 'transfer_in'::text, 'transfer_out'::text, 'cup_deposit'::text, 'cup_refund'::text, 'transport_fare'::text, 'ebike_rental'::text, 'partner_commission'::text])),
  reference_id uuid,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  ip_address inet,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT wallet_ledger_pkey PRIMARY KEY (ledger_id),
  CONSTRAINT wallet_ledger_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);
CREATE TABLE public.wallet_transactions (
  transaction_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['deposit'::text, 'withdrawal'::text, 'borrow_fee'::text, 'return_deposit'::text])),
  amount numeric NOT NULL,
  balance_after numeric NOT NULL,
  description text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT wallet_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT wallet_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(user_id)
);